name: Custom.ThreatHunt.HunterMatrix
description: |
  å¨èƒç‹©çŒå·¥ä»¶ - ç»“åˆVelociraptorè¡Œä¸ºAnalysiså’ŒHunterMatrixæ¶æ„SoftwareDetection
  
  è¿™ä¸ªå·¥ä»¶å®ç°äº†ä¸»åŠ¨å¨èƒç‹©çŒï¼ŒPackageæ‹¬ï¼š
  - Detectionå¯ç–‘FileOperation
  - AnalysisProcessè¡Œä¸º
  - Automaticè§¦å‘HunterMatrixæ‰«æ
  - ç”Ÿæˆå¨èƒæƒ…æŠ¥Report

author: Threat Hunting Team
version: 1.0

parameters:
  - name: HuntMode
    description: "ç‹©çŒæ¨¡å¼"
    default: "comprehensive"
    type: choices
    choices:
      - comprehensive: "å…¨é¢ç‹©çŒ"
      - suspicious_files: "å¯ç–‘File"
      - process_analysis: "ProcessAnalysis"
      - network_artifacts: "Networkå·¥ä»¶"
    
  - name: TimeRange
    description: "TimeèŒƒå›´(å°æ—¶)"
    default: 24
    type: int
    
  - name: HunterMatrixDatabase
    description: "HunterMatrixç—…æ¯’LibraryPath"
    default: "/var/lib/huntermatrix"
    type: string

sources:
  - name: SuspiciousFiles
    query: |
      -- Detectionå¯ç–‘File
      LET suspicious_files = SELECT FullPath, Size, Mtime, Atime,
                                   hash(path=FullPath, hashselect="MD5") AS MD5,
                                   hash(path=FullPath, hashselect="SHA256") AS SHA256
      FROM glob(globs=[
        "C:\\Users\\**\\Downloads\\*.exe",
        "C:\\Users\\**\\AppData\\**\\*.exe",
        "C:\\Temp\\*.exe",
        "C:\\Windows\\Temp\\*.exe",
        "C:\\ProgramData\\**\\*.exe"
      ])
      WHERE Mtime > timestamp(epoch=now() - TimeRange * 3600)
        AND Size > 1000  -- å¤§äº1KB
        AND Size < 100 * 1024 * 1024  -- å°äº100MB
      
      -- å¯¹å¯ç–‘FileExecuteHunterMatrixæ‰«æ
      LET scan_results = SELECT *,
        shell(cmd="clamscan",
              args=["--database=" + HunterMatrixDatabase,
                    "--no-summary",
                    "--infected",
                    FullPath]) AS HunterMatrixScan
      FROM suspicious_files
      
      SELECT FullPath,
             Size,
             Mtime,
             MD5,
             SHA256,
             HunterMatrixScan.ReturnCode AS ScanResult,
             if(condition=HunterMatrixScan.ReturnCode = 1,
                then="MALWARE_DETECTED",
                else="CLEAN") AS ThreatStatus,
             regex_replace(source=HunterMatrixScan.Stdout,
                          re=".*: (.+) FOUND.*",
                          replace="$1") AS MalwareName,
             "suspicious_file" AS HuntType
      FROM scan_results
      WHERE HuntMode = "suspicious_files" OR HuntMode = "comprehensive"

  - name: ProcessAnalysis
    query: |
      -- Analysiså¯ç–‘Process
      LET suspicious_processes = SELECT Pid, Ppid, Name, CommandLine, Exe,
                                       Username, CreateTime
      FROM pslist()
      WHERE (
        -- Detectionå¯ç–‘Processå
        Name =~ "(?i)(temp|tmp|cache|update|install|setup|download)" OR
        -- Detectionå¯ç–‘Path
        Exe =~ "(?i)(temp|tmp|appdata|programdata)" OR
        -- Detectionå¯ç–‘Commandè¡Œ
        CommandLine =~ "(?i)(powershell|cmd|wscript|cscript|regsvr32|rundll32)"
      )
      AND CreateTime > timestamp(epoch=now() - TimeRange * 3600)
      
      -- æ‰«æProcesså¯ExecuteFile
      LET process_scan = SELECT *,
        shell(cmd="clamscan",
              args=["--database=" + HunterMatrixDatabase,
                    "--no-summary",
                    "--infected",
                    Exe]) AS ProcessScan
      FROM suspicious_processes
      WHERE Exe
      
      SELECT Pid,
             Name,
             CommandLine,
             Exe,
             Username,
             CreateTime,
             ProcessScan.ReturnCode AS ScanResult,
             if(condition=ProcessScan.ReturnCode = 1,
                then="MALICIOUS_PROCESS",
                else="CLEAN_PROCESS") AS ThreatStatus,
             regex_replace(source=ProcessScan.Stdout,
                          re=".*: (.+) FOUND.*",
                          replace="$1") AS MalwareName,
             "process_analysis" AS HuntType
      FROM process_scan
      WHERE HuntMode = "process_analysis" OR HuntMode = "comprehensive"

  - name: NetworkArtifacts
    query: |
      -- DetectionNetworkç›¸å…³çš„å¯ç–‘File
      LET network_files = SELECT FullPath, Size, Mtime,
                                hash(path=FullPath, hashselect="MD5") AS MD5
      FROM glob(globs=[
        "C:\\Users\\**\\Downloads\\*.zip",
        "C:\\Users\\**\\Downloads\\*.rar",
        "C:\\Users\\**\\Downloads\\*.7z",
        "C:\\Users\\**\\Downloads\\*.tar",
        "C:\\Users\\**\\Downloads\\*.gz"
      ])
      WHERE Mtime > timestamp(epoch=now() - TimeRange * 3600)
        AND Size > 1024  -- å¤§äº1KB
      
      -- æ‰«æå‹ç¼©File
      LET archive_scan = SELECT *,
        shell(cmd="clamscan",
              args=["--database=" + HunterMatrixDatabase,
                    "--no-summary",
                    "--infected",
                    "--scan-archive",
                    FullPath]) AS ArchiveScan
      FROM network_files
      
      SELECT FullPath,
             Size,
             Mtime,
             MD5,
             ArchiveScan.ReturnCode AS ScanResult,
             if(condition=ArchiveScan.ReturnCode = 1,
                then="MALICIOUS_ARCHIVE",
                else="CLEAN_ARCHIVE") AS ThreatStatus,
             regex_replace(source=ArchiveScan.Stdout,
                          re=".*: (.+) FOUND.*",
                          replace="$1") AS MalwareName,
             "network_artifacts" AS HuntType
      FROM archive_scan
      WHERE HuntMode = "network_artifacts" OR HuntMode = "comprehensive"

  - name: ThreatSummary
    query: |
      -- æ±‡æ€»å¨èƒInformation
      LET all_threats = SELECT * FROM chain(
        a={ SELECT * FROM source(source="SuspiciousFiles") WHERE ThreatStatus = "MALWARE_DETECTED" },
        b={ SELECT * FROM source(source="ProcessAnalysis") WHERE ThreatStatus = "MALICIOUS_PROCESS" },
        c={ SELECT * FROM source(source="NetworkArtifacts") WHERE ThreatStatus = "MALICIOUS_ARCHIVE" }
      )
      
      SELECT count() AS TotalThreats,
             enumerate(items=MalwareName) AS ThreatTypes,
             enumerate(items=HuntType) AS HuntCategories,
             min(item=Mtime) AS EarliestThreat,
             max(item=Mtime) AS LatestThreat,
             timestamp(epoch=now()) AS HuntTime
      FROM all_threats

reports:
  - type: CLIENT
    template: |
      # ğŸ¦– å¨èƒç‹©çŒReport - HunterMatrixé›†æˆ
      
      **ç‹©çŒParameters:**
      - ç‹©çŒæ¨¡å¼: {{ .Parameters.HuntMode }}
      - TimeèŒƒå›´: {{ .Parameters.TimeRange }} å°æ—¶
      - HunterMatrixDataLibrary: {{ .Parameters.HunterMatrixDatabase }}
      
      ## ğŸ“Š å¨èƒæ‘˜è¦
      
      {{ range .ThreatSummary }}
      - **Foundå¨èƒTotal:** {{ .TotalThreats }}
      - **å¨èƒType:** {{ join .ThreatTypes ", " }}
      - **ç‹©çŒClassåˆ«:** {{ join .HuntCategories ", " }}
      - **æœ€æ—©å¨èƒTime:** {{ .EarliestThreat }}
      - **æœ€æ–°å¨èƒTime:** {{ .LatestThreat }}
      - **ç‹©çŒExecuteTime:** {{ .HuntTime }}
      {{ end }}
      
      ## ğŸš¨ å¯ç–‘Fileå¨èƒ
      
      {{ range .SuspiciousFiles }}
      {{ if eq .ThreatStatus "MALWARE_DETECTED" }}
      ### âš ï¸ æ¶æ„FileDetection
      
      - **FilePath:** `{{ .FullPath }}`
      - **æ¶æ„SoftwareName:** `{{ .MalwareName }}`
      - **FileSize:** {{ .Size }} å­—èŠ‚
      - **MD5:** `{{ .MD5 }}`
      - **SHA256:** `{{ .SHA256 }}`
      - **ModifyTime:** {{ .Mtime }}
      
      {{ end }}
      {{ end }}
      
      ## ğŸ” ProcessAnalysiså¨èƒ
      
      {{ range .ProcessAnalysis }}
      {{ if eq .ThreatStatus "MALICIOUS_PROCESS" }}
      ### âš ï¸ æ¶æ„ProcessDetection
      
      - **ProcessID:** {{ .Pid }}
      - **ProcessName:** `{{ .Name }}`
      - **Commandè¡Œ:** `{{ .CommandLine }}`
      - **å¯ExecuteFile:** `{{ .Exe }}`
      - **User:** {{ .Username }}
      - **æ¶æ„SoftwareName:** `{{ .MalwareName }}`
      - **CreateTime:** {{ .CreateTime }}
      
      {{ end }}
      {{ end }}
      
      ## ğŸ“¦ Networkå·¥ä»¶å¨èƒ
      
      {{ range .NetworkArtifacts }}
      {{ if eq .ThreatStatus "MALICIOUS_ARCHIVE" }}
      ### âš ï¸ æ¶æ„å‹ç¼©FileDetection
      
      - **FilePath:** `{{ .FullPath }}`
      - **æ¶æ„SoftwareName:** `{{ .MalwareName }}`
      - **FileSize:** {{ .Size }} å­—èŠ‚
      - **MD5:** `{{ .MD5 }}`
      - **ModifyTime:** {{ .Mtime }}
      
      {{ end }}
      {{ end }}
      
      ---
      
      ## ğŸ›¡ï¸ å»ºè®®æªæ–½
      
      1. **ç«‹å³éš”ç¦»** æ‰€HasDetectionåˆ°çš„æ¶æ„File
      2. **ç»ˆæ­¢** æ‰€Hasæ¶æ„Process
      3. **Update** ç—…æ¯’Libraryå’ŒSecurityPolicy
      4. **æ‰«æ** æ•´ä¸ªSystemä»¥ç¡®ä¿æ¸…æ´
      5. **Monitor** Networkæµé‡å’ŒSystemè¡Œä¸º
      
      *Reportç”ŸæˆTime: {{ timestamp(epoch=now()) }}*
